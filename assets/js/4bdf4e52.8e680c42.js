"use strict";(self.webpackChunkshuvi_document=self.webpackChunkshuvi_document||[]).push([[252],{9613:function(e,n,t){t.d(n,{Zo:function(){return d},kt:function(){return m}});var r=t(9496);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){a(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function o(e,n){if(null==e)return{};var t,r,a=function(e,n){if(null==e)return{};var t,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)t=i[r],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)t=i[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var p=r.createContext({}),u=function(e){var n=r.useContext(p),t=n;return e&&(t="function"==typeof e?e(n):l(l({},n),e)),t},d=function(e){var n=u(e.components);return r.createElement(p.Provider,{value:n},e.children)},s={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},c=r.forwardRef((function(e,n){var t=e.components,a=e.mdxType,i=e.originalType,p=e.parentName,d=o(e,["components","mdxType","originalType","parentName"]),c=u(t),m=a,g=c["".concat(p,".").concat(m)]||c[m]||s[m]||i;return t?r.createElement(g,l(l({ref:n},d),{},{components:t})):r.createElement(g,l({ref:n},d))}));function m(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var i=t.length,l=new Array(i);l[0]=c;var o={};for(var p in n)hasOwnProperty.call(n,p)&&(o[p]=n[p]);o.originalType=e,o.mdxType="string"==typeof e?e:a,l[1]=o;for(var u=2;u<i;u++)l[u]=t[u];return r.createElement.apply(null,l)}return r.createElement.apply(null,t)}c.displayName="MDXCreateElement"},3047:function(e,n,t){t.r(n),t.d(n,{assets:function(){return d},contentTitle:function(){return p},default:function(){return m},frontMatter:function(){return o},metadata:function(){return u},toc:function(){return s}});var r=t(2848),a=t(9213),i=(t(9496),t(9613)),l=["components"],o={id:"serverPlugin-api",title:"ServerPlugin API",sidebar_position:2},p=void 0,u={unversionedId:"api-reference/plugin/serverPlugin-api",id:"api-reference/plugin/serverPlugin-api",title:"ServerPlugin API",description:"To create a serverPlugin, use",source:"@site/docs/api-reference/plugin/serverPlugin-api.md",sourceDirName:"api-reference/plugin",slug:"/api-reference/plugin/serverPlugin-api",permalink:"/shuvijs.org/docs/api-reference/plugin/serverPlugin-api",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/api-reference/plugin/serverPlugin-api.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{id:"serverPlugin-api",title:"ServerPlugin API",sidebar_position:2},sidebar:"apiReferenceSidebar",previous:{title:"CorePlugin API",permalink:"/shuvijs.org/docs/api-reference/plugin/corePlugin-api"},next:{title:"RuntimePlugin API",permalink:"/shuvijs.org/docs/api-reference/plugin/runtimePlugin-api"}},d={},s=[{value:"Context",id:"context",level:2},{value:"<code>serverPluginRunner</code>",id:"serverpluginrunner",level:4},{value:"<code>onListen</code>",id:"onlisten",level:3},{value:"<code>addProxy</code>",id:"addproxy",level:3},{value:"<code>addMiddleware</code>",id:"addmiddleware",level:3},{value:"<code>renderToHTML</code>",id:"rendertohtml",level:3},{value:"<code>pageData</code>",id:"pagedata",level:3},{value:"Extending types",id:"extending-types",level:2}],c={toc:s};function m(e){var n=e.components,t=(0,a.Z)(e,l);return(0,i.kt)("wrapper",(0,r.Z)({},c,t,{components:n,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"To create a serverPlugin, use"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"import { createServerPlugin } from 'shuvi'\n")),(0,i.kt)("h2",{id:"context"},"Context"),(0,i.kt)("p",null,"The context stores a series of useful data and utils and can be visit in the last parameter of every hook handler."),(0,i.kt)("p",null,"The context of serverPlugin has all the fields of the context of corePlugin, and the following field."),(0,i.kt)("h4",{id:"serverpluginrunner"},(0,i.kt)("inlineCode",{parentName:"h4"},"serverPluginRunner")),(0,i.kt)("p",null,"An object containing every hook runner."),(0,i.kt)("p",null,"Example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"context.serverPluginRunner[hookName]()              // if initialValue and extraArg are void\ncontext.serverPluginRunner[hookName](extraArg)      // if initialValue is void\ncontext.serverPluginRunner[hookName](initialValue)  // if extraArg is void\n")),(0,i.kt)("h3",{id:"onlisten"},(0,i.kt)("inlineCode",{parentName:"h3"},"onListen")),(0,i.kt)("p",null,"will executed on server listening."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"hookType: ",(0,i.kt)("inlineCode",{parentName:"li"},"AsyncParallelHook")),(0,i.kt)("li",{parentName:"ul"},"initialValue: ",(0,i.kt)("inlineCode",{parentName:"li"},"{ port: number; hostname?: string }")),(0,i.kt)("li",{parentName:"ul"},"extraArg: ",(0,i.kt)("inlineCode",{parentName:"li"},"void")),(0,i.kt)("li",{parentName:"ul"},"returnType: ",(0,i.kt)("inlineCode",{parentName:"li"},"void"))),(0,i.kt)("h3",{id:"addproxy"},(0,i.kt)("inlineCode",{parentName:"h3"},"addProxy")),(0,i.kt)("p",null,"add local api proxy, usually works at development mode."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"hookType: ",(0,i.kt)("inlineCode",{parentName:"li"},"AsyncParallelHook")),(0,i.kt)("li",{parentName:"ul"},"initialValue: ",(0,i.kt)("inlineCode",{parentName:"li"},"void")),(0,i.kt)("li",{parentName:"ul"},"extraArg: ",(0,i.kt)("inlineCode",{parentName:"li"},"void")),(0,i.kt)("li",{parentName:"ul"},"returnType: ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/chimurai/http-proxy-middleware#http-proxy-options"},"ProxyOptions")," | ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/chimurai/http-proxy-middleware#http-proxy-options"},"ProxyOptions"),"[]")),(0,i.kt)("p",null,"Example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"export default createServerPlugin({\n  addProxy: () => {\n    const isDev = process.env.NODE_ENV === 'development'\n    return isDev ? {\n      context: (pathname) => /^\\/api/.test(pathname),\n      target: process.env.API_HOST,\n    } : []\n  }\n})\n")),(0,i.kt)("h3",{id:"addmiddleware"},(0,i.kt)("inlineCode",{parentName:"h3"},"addMiddleware")),(0,i.kt)("p",null,"add server middlewares with express-style."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"hookType: ",(0,i.kt)("inlineCode",{parentName:"p"},"AsyncParallelHook"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"initialValue: ",(0,i.kt)("inlineCode",{parentName:"p"},"void"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"extraArg: ",(0,i.kt)("inlineCode",{parentName:"p"},"void"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"returnType: ",(0,i.kt)("inlineCode",{parentName:"p"},"IServerMiddleware | IServerMiddleware[]")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"type IServerMiddleware = IMiddlewareHandler | \n  { \n    path: string; \n    handler: IMiddlewareHandler \n  };\n\ntype IMiddlewareHandler = \n  (res: IRequest, req: http.ServerResponse, next: (err?: any) => void)\n    => void | Promise<void>\n\ninterface IRequest extends http.IIncomingMessage {\n  url: string;\n  pathname: string;\n  query: Record<string, any>;\n  params: Record<string, any>;;\n  headers: http.IncomingHttpHeaders;\n}\n\ninterface IResponse extends http.ServerResponse {}\n")))),(0,i.kt)("p",null,"Example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"export default createServerPlugin({\n  addProxy: () => [{\n    path: 'test',\n    handler: (_, _, next) => {\n      console.log(1);\n      next();\n    }\n  }]\n})\n")),(0,i.kt)("h3",{id:"rendertohtml"},(0,i.kt)("inlineCode",{parentName:"h3"},"renderToHTML")),(0,i.kt)("p",null,"modify how to render app component to html"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"hookType: ",(0,i.kt)("inlineCode",{parentName:"li"},"AsyncSeriesWaterfallHook")),(0,i.kt)("li",{parentName:"ul"},"initialValue: ",(0,i.kt)("inlineCode",{parentName:"li"},"IRenderToHTML"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"type IRenderToHTML = (\n  req: http.IncomingMessage,\n  res: http.ServerResponse\n) => Promise<string | null>;\n"))),(0,i.kt)("li",{parentName:"ul"},"extraArg: ",(0,i.kt)("inlineCode",{parentName:"li"},"void"))),(0,i.kt)("p",null,"Example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"export default createServerPlugin({\n  renderToHTML: renderToHTML => {\n    return async (req, res) => {\n      const html = await renderToHTML(req, res);\n      console.log('custom-renderToHTML', html);\n      return html;\n    };\n  }\n})\n")),(0,i.kt)("h3",{id:"pagedata"},(0,i.kt)("inlineCode",{parentName:"h3"},"pageData")),(0,i.kt)("p",null,"Add properties to ",(0,i.kt)("inlineCode",{parentName:"p"},"pageData")," object."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"hookType: ",(0,i.kt)("inlineCode",{parentName:"li"},"AsyncParallelHook")),(0,i.kt)("li",{parentName:"ul"},"initialValue: ",(0,i.kt)("inlineCode",{parentName:"li"},"void")),(0,i.kt)("li",{parentName:"ul"},"extraArg: ",(0,i.kt)("inlineCode",{parentName:"li"},"AppContext")," (same as ",(0,i.kt)("a",{parentName:"li",href:"/shuvijs.org/docs/api-reference/plugin/runtimePlugin-api#getappcontext"},"RuntimePlugin API/getAppContext"),")"),(0,i.kt)("li",{parentName:"ul"},"returnType: ",(0,i.kt)("inlineCode",{parentName:"li"},"Record<string, unknown>"))),(0,i.kt)("p",null,"Example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"export default createServerPlugin({\n  pageData: appContext => {\n    const { test } = appContext;\n    return {\n      test\n    };\n  }\n})\n")),(0,i.kt)("h2",{id:"extending-types"},"Extending types"),(0,i.kt)("p",null,"The type of serverPlugin hooks can be extended as the following example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="types.d.ts"',title:'"types.d.ts"'},"declare module '@shuvi/runtime' {\n  export interface CustomServerPluginHooks {\n    extendedHookExample: typeof extendedHookExample\n  }\n}\n")))}m.isMDXComponent=!0}}]);