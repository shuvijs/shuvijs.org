"use strict";(self.webpackChunkshuvi_document=self.webpackChunkshuvi_document||[]).push([[7156],{9613:(e,t,a)=>{a.d(t,{Zo:()=>u,kt:()=>c});var n=a(9496);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function l(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?l(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):l(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function i(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},l=Object.keys(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var p=n.createContext({}),s=function(e){var t=n.useContext(p),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},u=function(e){var t=s(e.components);return n.createElement(p.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,l=e.originalType,p=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),m=s(a),c=r,k=m["".concat(p,".").concat(c)]||m[c]||d[c]||l;return a?n.createElement(k,o(o({ref:t},u),{},{components:a})):n.createElement(k,o({ref:t},u))}));function c(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=a.length,o=new Array(l);o[0]=m;var i={};for(var p in t)hasOwnProperty.call(t,p)&&(i[p]=t[p]);i.originalType=e,i.mdxType="string"==typeof e?e:r,o[1]=i;for(var s=2;s<l;s++)o[s]=a[s];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}m.displayName="MDXCreateElement"},9284:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>p,contentTitle:()=>o,default:()=>d,frontMatter:()=>l,metadata:()=>i,toc:()=>s});var n=a(2081),r=(a(9496),a(9613));const l={sidebar_position:2,id:"Routes"},o=void 0,i={unversionedId:"guide/Routes",id:"guide/Routes",title:"Routes",description:"Shuvi provides a file system-based convention routing rule.",source:"@site/docs/guide/routes.md",sourceDirName:"guide",slug:"/guide/Routes",permalink:"/shuvijs.org/docs/guide/Routes",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/guide/routes.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2,id:"Routes"},sidebar:"guideSidebar",previous:{title:"Basic Support",permalink:"/shuvijs.org/docs/guide/Basic Support"},next:{title:"Server",permalink:"/shuvijs.org/docs/guide/Server"}},p={},s=[{value:"Conventions rules",id:"conventions-rules",level:2},{value:"Dynamic rules",id:"dynamic-rules",level:2},{value:"Catch all routes",id:"catch-all-routes",level:3},{value:"Optional catch all routes",id:"optional-catch-all-routes",level:3},{value:"general rules",id:"general-rules",level:3},{value:"Page routes",id:"page-routes",level:2},{value:"Usage",id:"usage",level:3},{value:"Example",id:"example",level:3},{value:"Layout",id:"layout",level:2},{value:"Usage",id:"usage-1",level:3},{value:"Example",id:"example-1",level:3},{value:"API routes",id:"api-routes",level:2},{value:"Usage",id:"usage-2",level:3},{value:"Example",id:"example-2",level:3},{value:"enhanced request",id:"enhanced-request",level:3},{value:"Custom config",id:"custom-config",level:3},{value:"enhanced response",id:"enhanced-response",level:3},{value:"Middleware routes",id:"middleware-routes",level:2},{value:"Usage",id:"usage-3",level:3},{value:"Execution Order",id:"execution-order",level:3},{value:"Config",id:"config",level:3},{value:"Match rules",id:"match-rules",level:2},{value:"Custom Regexp in params",id:"custom-regexp-in-params",level:3},{value:"Repeatable params",id:"repeatable-params",level:3},{value:"Optional parameters",id:"optional-parameters",level:3},{value:"Catch all / 404 Not found Route",id:"catch-all--404-not-found-route",level:3},{value:"different between math all",id:"different-between-math-all",level:3},{value:"Debugging",id:"debugging",level:3},{value:"On demand transpilation",id:"on-demand-transpilation",level:2}],u={toc:s};function d(e){let{components:t,...a}=e;return(0,r.kt)("wrapper",(0,n.Z)({},u,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"Shuvi provides a file system-based convention routing rule.\nRead the agreed files from ",(0,r.kt)("strong",{parentName:"p"},"src/routes")," in the project root directory,\nsuch as page.js, ",(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("inlineCode",{parentName:"strong"},"layout.js")),", ",(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("inlineCode",{parentName:"strong"},"api.js")),", ",(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("inlineCode",{parentName:"strong"},"middleware.js")),".\nWhich produces the corresponding ",(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("inlineCode",{parentName:"strong"},"React Component"))," routing hierarchy."),(0,r.kt)("h2",{id:"conventions-rules"},"Conventions rules"),(0,r.kt)("p",null,"The names of the directories under src/routes determine the rules for generating routes"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Example"),":"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"directory path"),(0,r.kt)("th",{parentName:"tr",align:null},"route path"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"src/routes/"),(0,r.kt)("td",{parentName:"tr",align:null},"/")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"src/routes/a"),(0,r.kt)("td",{parentName:"tr",align:null},"/a")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"src/routes/a/a1"),(0,r.kt)("td",{parentName:"tr",align:null},"/a/a1")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"src/routes/b"),(0,r.kt)("td",{parentName:"tr",align:null},"/b")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"src/routes/b/b1"),(0,r.kt)("td",{parentName:"tr",align:null},"/b/b1")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"src/routes/b/b2"),(0,r.kt)("td",{parentName:"tr",align:null},"/b/b2")))),(0,r.kt)("h2",{id:"dynamic-rules"},"Dynamic rules"),(0,r.kt)("p",null,"Defining routes by using predefined paths is not always enough for complex applications.\nIn shuvi you can add brackets to a directory name (",(0,r.kt)("inlineCode",{parentName:"p"},"[param]"),") to create a dynamic route (a.k.a. url slugs, pretty urls, and others)."),(0,r.kt)("p",null,"Consider the following directory ",(0,r.kt)("inlineCode",{parentName:"p"},"routes/post/[pid]"),":"),(0,r.kt)("p",null,"Any route like ",(0,r.kt)("inlineCode",{parentName:"p"},"/post/1"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"/post/abc"),", etc. will be matched by ",(0,r.kt)("inlineCode",{parentName:"p"},"routes/post/[pid]"),"."),(0,r.kt)("p",null,"For example, the route ",(0,r.kt)("inlineCode",{parentName:"p"},"/post/abc")," will have the following ",(0,r.kt)("inlineCode",{parentName:"p"},"params")," object:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{ "pid": "abc" }\n')),(0,r.kt)("p",null,"Similarly, the route ",(0,r.kt)("inlineCode",{parentName:"p"},"/post/abc?foo=bar")," will have the following ",(0,r.kt)("inlineCode",{parentName:"p"},"params")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"query")," object:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json",metastring:"lines",lines:!0},'// params\n{"pid": "abc"}\n// query\n{ "foo": "bar" }\n')),(0,r.kt)("p",null,"Multiple dynamic route segments work the same way. The page ",(0,r.kt)("inlineCode",{parentName:"p"},"routes/post/[pid]/[comment]")," will match the route ",(0,r.kt)("inlineCode",{parentName:"p"},"/post/abc/a-comment")," and its ",(0,r.kt)("inlineCode",{parentName:"p"},"params")," object will be:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{ "pid": "abc", "comment": "a-comment" }\n')),(0,r.kt)("h3",{id:"catch-all-routes"},"Catch all routes"),(0,r.kt)("p",null,"Dynamic routes can be extended to catch all paths by adding three dots (",(0,r.kt)("inlineCode",{parentName:"p"},"..."),") inside the brackets. For example:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"routes/post/[...slug]")," matches ",(0,r.kt)("inlineCode",{parentName:"li"},"/post/a"),", but also ",(0,r.kt)("inlineCode",{parentName:"li"},"/post/a/b"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"/post/a/b/c")," and so on.")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("strong",{parentName:"p"},"Note"),": You can use names other than ",(0,r.kt)("inlineCode",{parentName:"p"},"slug"),", such as: ",(0,r.kt)("inlineCode",{parentName:"p"},"[...param]"))),(0,r.kt)("p",null,"Matched parameters will be sent as a query parameter (",(0,r.kt)("inlineCode",{parentName:"p"},"slug")," in the example) to the page, and it will always be an array, so, the path ",(0,r.kt)("inlineCode",{parentName:"p"},"/post/a")," will have the following ",(0,r.kt)("inlineCode",{parentName:"p"},"params")," object:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{ "slug": ["a"] }\n')),(0,r.kt)("p",null,"And in the case of ",(0,r.kt)("inlineCode",{parentName:"p"},"/post/a/b"),", and any other matching path, new parameters will be added to the array, like so:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{ "slug": ["a", "b"] }\n')),(0,r.kt)("h3",{id:"optional-catch-all-routes"},"Optional catch all routes"),(0,r.kt)("p",null,"Catch all routes can be made optional by including the parameter in double brackets (",(0,r.kt)("inlineCode",{parentName:"p"},"[[...slug]]"),")."),(0,r.kt)("p",null,"For example, ",(0,r.kt)("inlineCode",{parentName:"p"},"routes/post/[[...slug]]")," will match ",(0,r.kt)("inlineCode",{parentName:"p"},"/post"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"/post/a"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"/post/a/b"),", and so on."),(0,r.kt)("p",null,"The main difference between catch all and optional catch all routes is that with optional, the route without the parameter is also matched (",(0,r.kt)("inlineCode",{parentName:"p"},"/post")," in the example above)."),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"params")," objects are as follows:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json",metastring:"lines",lines:!0},'{ "slug": [] } // GET `/post` (empty array)\n{ "slug": ["a"] } // `GET /post/a` (single-element array)\n{ "slug": ["a", "b"] } // `GET /post/a/b` (multi-element array)\n')),(0,r.kt)("h3",{id:"general-rules"},"general rules"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"path"),(0,r.kt)("th",{parentName:"tr",align:null},"route"),(0,r.kt)("th",{parentName:"tr",align:null},"matched url"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"routes/post/create"),(0,r.kt)("td",{parentName:"tr",align:null},"/post/create"),(0,r.kt)("td",{parentName:"tr",align:null},"/post/create")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"routes/post/","[pid]"),(0,r.kt)("td",{parentName:"tr",align:null},"/post/:pid"),(0,r.kt)("td",{parentName:"tr",align:null},"/post/1, /post/abc")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"routes/post/[","[pid]","]"),(0,r.kt)("td",{parentName:"tr",align:null},"/post/:pid?"),(0,r.kt)("td",{parentName:"tr",align:null},"/post, /post/1, /post/abc")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"routes/post/","[...pid]"),(0,r.kt)("td",{parentName:"tr",align:null},"/post/:pid+"),(0,r.kt)("td",{parentName:"tr",align:null},"/post/1/2, /post/a/b/c")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"routes/post/[","[...pid]","]"),(0,r.kt)("td",{parentName:"tr",align:null},"/post/:pid*"),(0,r.kt)("td",{parentName:"tr",align:null},"/post, /post/1/2, /post/a/b/c")))),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"[details about matched rules]","(#Match rules)")),(0,r.kt)("h2",{id:"page-routes"},"Page routes"),(0,r.kt)("p",null,"The directory name determines the path, page.js determines the rendered content.\n",(0,r.kt)("inlineCode",{parentName:"p"},"page.js")," should export a ",(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("inlineCode",{parentName:"strong"},"React component"))," by default.page.js is leaf node in the routing tree\uff0c\nCan be nested in any folder."),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Note that all future examples will use the .js extension.\nThe extension of the routing file is not limited to ",(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("inlineCode",{parentName:"strong"},".js")),", but can also be ",(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("inlineCode",{parentName:"strong"},".ts")),", ",(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("inlineCode",{parentName:"strong"},".tsx")),", and ",(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("inlineCode",{parentName:"strong"},".jsx")),".")),(0,r.kt)("h3",{id:"usage"},"Usage"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Create a ",(0,r.kt)("inlineCode",{parentName:"li"},"page.js")," file under your ",(0,r.kt)("inlineCode",{parentName:"li"},"routes")," directory."),(0,r.kt)("li",{parentName:"ol"},"Finally, export a React component function from the ",(0,r.kt)("inlineCode",{parentName:"li"},"page.js")," file by default.")),(0,r.kt)("h3",{id:"example"},"Example"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-jsx"},"export default function Index() {\n  return <div>index</div>\n}\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-jsx"},"export default function Index() {\n  return <div>a-b</div>\n}\n")),(0,r.kt)("h2",{id:"layout"},"Layout"),(0,r.kt)("p",null,"Layout is suitable for scenarios that require nested routing.\nSimilar to the ",(0,r.kt)("inlineCode",{parentName:"p"},"<router-view>")," of ",(0,r.kt)("inlineCode",{parentName:"p"},"Vue-router"),"."),(0,r.kt)("p",null,"Layout can be understood as a more advanced page, it has all the capabilities of page,\nand has the ability to share areas without repeated rendering and scheduling of sub-routes."),(0,r.kt)("h3",{id:"usage-1"},"Usage"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Create a ",(0,r.kt)("inlineCode",{parentName:"li"},"layout.js")," file under your ",(0,r.kt)("inlineCode",{parentName:"li"},"routes")," directory."),(0,r.kt)("li",{parentName:"ol"},"Finally, export a React component function from the ",(0,r.kt)("inlineCode",{parentName:"li"},"layout.js")," file by default."),(0,r.kt)("li",{parentName:"ol"},"Use 'RouterView Component' to render your child routes")),(0,r.kt)("h3",{id:"example-1"},"Example"),(0,r.kt)("p",null,"A small example of a shared top navigation bar."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("inlineCode",{parentName:"strong"},"src/routes/dashboard/layout.js"))," \u2192 ",(0,r.kt)("inlineCode",{parentName:"p"},"/dashboard")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-jsx"},'import { RouterView } from \'@shuvi/runtime\';\n\nexport default function Layout() {\n  return (\n    <div>\n      <header>\n        <h1>dashboard</h1>\n        <nav>\n          <Link to="categories">categories</Link>\n          <Link to="articles">articles</Link>\n          <Link to="tags">tags</Link>\n        </nav>\n      </header>\n      <main>\n        <RouterView />\n      </main>\n    </div>\n  )\n}\n')),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("inlineCode",{parentName:"strong"},"src/routes/dashboard/categories/page.js"))," \u2192 ",(0,r.kt)("inlineCode",{parentName:"p"},"/dashboard/categories")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-jsx"},"export default function () {\n  return <div>categories</div>\n}\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("inlineCode",{parentName:"strong"},"src/routes/dashboard/articles/page.js"))," \u2192 ",(0,r.kt)("inlineCode",{parentName:"p"},"/dashboard/articles")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-jsx"},"export default function () {\n  return <div>articles</div>\n}\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("inlineCode",{parentName:"strong"},"src/routes/dashboard/tags/page.js"))," \u2192 ",(0,r.kt)("inlineCode",{parentName:"p"},"/dashboard/tags")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-jsx"},"export default function () {\n  return <div>tags</div>\n}\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("inlineCode",{parentName:"strong"},"src/routes/dashboard/page.js"))," \u2192 ",(0,r.kt)("inlineCode",{parentName:"p"},"/dashboard")," can be used as index route."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-jsx"},"export default function () {\n  return <div>index</div>\n}\n")),(0,r.kt)("p",null,"Now,\naccessing any sub-route under /dashboard/ will render the matching layout and page together.\nWhen the route changes, the layout will not be unmounted.\nImplemented regional component sharing"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},(0,r.kt)("strong",{parentName:"p"},"Notice"),": Layout and page do not conflict with dynamic segment and can be freely combined.")),(0,r.kt)("h2",{id:"api-routes"},"API routes"),(0,r.kt)("p",null,"API routes provide a solution to build your ",(0,r.kt)("strong",{parentName:"p"},"API")," with shuvi."),(0,r.kt)("p",null,"Any file inside the folder ",(0,r.kt)("inlineCode",{parentName:"p"},"src/routes"),", each api is associated with a route based on its file name. They are server-side only bundles and won't increase your client-side bundle size."),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"path"),(0,r.kt)("th",{parentName:"tr",align:null},"route"),(0,r.kt)("th",{parentName:"tr",align:null},"matched url"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"routes/api/post/create/api.js"),(0,r.kt)("td",{parentName:"tr",align:null},"/api/post/create"),(0,r.kt)("td",{parentName:"tr",align:null},"/api/post/create")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"routes/api/post/","[pid]","/api.js"),(0,r.kt)("td",{parentName:"tr",align:null},"/api/post/:pid"),(0,r.kt)("td",{parentName:"tr",align:null},"/api/post/1, /api/post/abc")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"routes/api/post/[","[pid]","]/api.js"),(0,r.kt)("td",{parentName:"tr",align:null},"/api/post/:pid?"),(0,r.kt)("td",{parentName:"tr",align:null},"/api/post, /api/post/1, /api/post/abc")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"routes/api/post/","[...pid]","/api.js"),(0,r.kt)("td",{parentName:"tr",align:null},"/api/post/:pid+"),(0,r.kt)("td",{parentName:"tr",align:null},"/api/post/1/2, /api/post/a/b/c")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"routes/api/post/[","[...pid]","]/api.js"),(0,r.kt)("td",{parentName:"tr",align:null},"/api/post/:pid*"),(0,r.kt)("td",{parentName:"tr",align:null},"/api/post, /api/post/1/2, /api/post/a/b/c")))),(0,r.kt)("h3",{id:"usage-2"},"Usage"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Create a ",(0,r.kt)("inlineCode",{parentName:"li"},"api.js")," file under your ",(0,r.kt)("inlineCode",{parentName:"li"},"routes")," directory."),(0,r.kt)("li",{parentName:"ol"},"Finally, export an api function from the ",(0,r.kt)("inlineCode",{parentName:"li"},"api.js")," file by default.")),(0,r.kt)("h3",{id:"example-2"},"Example"),(0,r.kt)("p",null,"For example, the following API route ",(0,r.kt)("inlineCode",{parentName:"p"},"routes/api/user/api.js")," returns a ",(0,r.kt)("inlineCode",{parentName:"p"},"json")," response with a status code of ",(0,r.kt)("inlineCode",{parentName:"p"},"200"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"export default function handler(req, res) {\n  res.status(200).json({ name: 'John Doe' })\n}\n")),(0,r.kt)("p",null,"For an API route to work, you need to export a function as default (a.k.a ",(0,r.kt)("strong",{parentName:"p"},"request handler"),"), which then receives the following parameters:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"req"),": An instance of ",(0,r.kt)("a",{parentName:"li",href:"https://nodejs.org/api/http.html#http_class_http_incomingmessage"},"http.IncomingMessage"),", plus some ",(0,r.kt)("a",{parentName:"li",href:"#enhanced-request"},"enhanced request")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"res"),": An instance of ",(0,r.kt)("a",{parentName:"li",href:"https://nodejs.org/api/http.html#http_class_http_serverresponse"},"http.ServerResponse"),", plus some ",(0,r.kt)("a",{parentName:"li",href:"#enhanced-response"},"enhanced response"))),(0,r.kt)("p",null,"To handle different HTTP methods in an API route, you can use ",(0,r.kt)("inlineCode",{parentName:"p"},"req.method")," in your request handler, like so:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"import { RuntimeServer } from '@shuvi/runtime'\nconst apiHandler: RuntimeServer.IApiRequestHandler = function handler(req, res) {\n  if (req.method === 'POST') {\n    // Process a POST request\n  } else {\n    // Handle any other HTTP method\n  }\n}\nexport default apiHandler\n")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Details of ",(0,r.kt)("inlineCode",{parentName:"p"},"RuntimeServer.IApiRequestHandler")," types is ",(0,r.kt)("a",{parentName:"p",href:"/shuvijs.org/docs/api-reference/runtime/modules/RuntimeServer#iapirequesthandler"},"here"))),(0,r.kt)("p",null,"To fetch API endpoints, take a look into any of the examples at the start of this section."),(0,r.kt)("h3",{id:"enhanced-request"},"enhanced request"),(0,r.kt)("p",null,"API routes provide built in middlewares which parse the incoming request (",(0,r.kt)("inlineCode",{parentName:"p"},"req"),"). Those middlewares are:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"req.cookies")," - An object containing the cookies sent by the request. Defaults to ",(0,r.kt)("inlineCode",{parentName:"li"},"{}")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"req.query")," - An object containing the ",(0,r.kt)("a",{parentName:"li",href:"https://en.wikipedia.org/wiki/Query_string"},"query string"),". Defaults to ",(0,r.kt)("inlineCode",{parentName:"li"},"{}")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"req.body")," - An object containing the body parsed by ",(0,r.kt)("inlineCode",{parentName:"li"},"content-type"),", or ",(0,r.kt)("inlineCode",{parentName:"li"},"null")," if no body was sent")),(0,r.kt)("h3",{id:"custom-config"},"Custom config"),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"apiConfig")," object includes all configs available for API routes."),(0,r.kt)("p",null,"Every API route can export a ",(0,r.kt)("inlineCode",{parentName:"p"},"config")," object to change the default configs, which are the following:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"export const config = {\n  apiConfig: {\n    bodyParser: {\n      sizeLimit: '1mb',\n    },\n  },\n}\n")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"bodyParser")," Enables body parsing, you can disable it if you want to consume it as a ",(0,r.kt)("inlineCode",{parentName:"p"},"Stream"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"export const config = {\n  apiConfig: {\n    bodyParser: false,\n  },\n}\n")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"bodyParser.sizeLimit")," is the maximum size allowed for the parsed body, in any format supported by ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/visionmedia/bytes.js"},"bytes"),", like so:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"export const config = {\n  apiConfig: {\n    bodyParser: {\n      sizeLimit: '500kb',\n    },\n  },\n}\n")),(0,r.kt)("h3",{id:"enhanced-response"},"enhanced response"),(0,r.kt)("p",null,"The response (",(0,r.kt)("inlineCode",{parentName:"p"},"res"),") includes a set of Express.js-like methods to improve the developer experience and increase the speed of creating new API endpoints, take a look at the following example:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"export default function handler(req, res) {\n  res.status(200).json({ name: 'shuvi' })\n}\n")),(0,r.kt)("p",null,"The included helpers are:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"res.status(code)")," - A function to set the status code. ",(0,r.kt)("inlineCode",{parentName:"li"},"code")," must be a valid ",(0,r.kt)("a",{parentName:"li",href:"https://en.wikipedia.org/wiki/List_of_HTTP_status_codes"},"HTTP status code")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"res.json(body)")," - Sends a JSON response. ",(0,r.kt)("inlineCode",{parentName:"li"},"body")," must be a ",(0,r.kt)("a",{parentName:"li",href:"https://developer.mozilla.org/en-US/docs/Glossary/Serialization"},"serialiazable object")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"res.send(body)")," - Sends the HTTP response. ",(0,r.kt)("inlineCode",{parentName:"li"},"body")," can be a ",(0,r.kt)("inlineCode",{parentName:"li"},"string"),", an ",(0,r.kt)("inlineCode",{parentName:"li"},"object")," or a ",(0,r.kt)("inlineCode",{parentName:"li"},"Buffer")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"res.redirect([status,] path)")," - Redirects to a specified path or URL. ",(0,r.kt)("inlineCode",{parentName:"li"},"status")," must be a valid ",(0,r.kt)("a",{parentName:"li",href:"https://en.wikipedia.org/wiki/List_of_HTTP_status_codes"},"HTTP status code"),". If not specified, ",(0,r.kt)("inlineCode",{parentName:"li"},"status"),' defaults to "307" "Temporary redirect".')),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Notice: api.js and page.js are conflicting, when both exist, only page.js will be enabled.")),(0,r.kt)("h2",{id:"middleware-routes"},"Middleware routes"),(0,r.kt)("p",null,"Middleware enables you to use code over configuration. This gives you full flexibility in shuvi, because you can run code before a request is completed."),(0,r.kt)("p",null,"Based on the user's incoming request, you can modify the response by rewriting, redirecting, adding headers."),(0,r.kt)("h3",{id:"usage-3"},"Usage"),(0,r.kt)("p",null,"Middleware is created by using a ",(0,r.kt)("inlineCode",{parentName:"p"},"middleware")," function that lives inside a ",(0,r.kt)("inlineCode",{parentName:"p"},"middleware.js")," file."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Create a ",(0,r.kt)("inlineCode",{parentName:"p"},"middleware.ts")," file under your ",(0,r.kt)("inlineCode",{parentName:"p"},"routes")," directory.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Finally, export a middleware function from the ",(0,r.kt)("inlineCode",{parentName:"p"},"middleware.ts")," file."))),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-tsx"},"// routes/middleware.ts\n\nimport { RuntimeServer } from '@shuvi/runtime'\n\nexport const middleware:RuntimeServer.IRequestHandlerWithNext = function (req, res, next) {\n  console.log('req.url :', req.url);\n  return next();\n}\n")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Details of ",(0,r.kt)("inlineCode",{parentName:"p"},"RuntimeServer.IRequestHandlerWithNext")," types is ",(0,r.kt)("a",{parentName:"p",href:"/shuvijs.org/docs/api-reference/runtime/modules/RuntimeServer#irequesthandlerwithnext"},"here"))),(0,r.kt)("h3",{id:"execution-order"},"Execution Order"),(0,r.kt)("p",null,"If your Middleware is created in ",(0,r.kt)("inlineCode",{parentName:"p"},"/src/routes/middleware.ts"),", it will run on all routes within the ",(0,r.kt)("inlineCode",{parentName:"p"},"routes")," directory. The below example assumes you have ",(0,r.kt)("inlineCode",{parentName:"p"},"routes/about/page.tsx")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"routes/teams/page.tsx")," routes."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"- package.json\n- /routes\n    middleware.ts # Will run on all routes under /routes\n    page.tsx\n    about\n      page.tsx\n    teams\n      page.tsx\n")),(0,r.kt)("p",null,"If you ",(0,r.kt)("em",{parentName:"p"},"do")," have sub-directories with nested routes, middleware will run from the top down. For example, if you have ",(0,r.kt)("inlineCode",{parentName:"p"},"routes/about/middleware.ts")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"routes/about/team/middleware.ts"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"/about")," will run first and then ",(0,r.kt)("inlineCode",{parentName:"p"},"/about/team"),". The below example show how this works with a nested routing structure."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"- package.json\n- /routes\n    page.tsx\n    - /about\n      middleware.ts # Will run first\n      about\n        page.tsx\n      - /teams\n          middleware.ts # Will run second\n          page.tsx\n")),(0,r.kt)("h3",{id:"config"},"Config"),(0,r.kt)("p",null,"You can also define middleware routing in shuvi.config.js."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"example"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"// shuvi.config.js\nexport default {\n  middlewareRoutes: [\n    // start with /a\n    {\n      path: '/a/:rest*',\n      middlewares: ['a/m.js']\n    },\n    // only /a/a1\n    {\n      path: '/a/a1',\n      middlewares: ['a/a1/m.js']\n    },\n    // catch all\n    {\n      path: '/',\n      middlewares: ['m.js']\n    }\n  ]\n};\n")),(0,r.kt)("h2",{id:"match-rules"},"Match rules"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"A ",(0,r.kt)("em",{parentName:"li"},"param")," is denoted by a colon ",(0,r.kt)("inlineCode",{parentName:"li"},":")),(0,r.kt)("li",{parentName:"ol"},"colon ",(0,r.kt)("inlineCode",{parentName:"li"},":")," is ",(0,r.kt)("strong",{parentName:"li"},"necessary")," for ",(0,r.kt)("em",{parentName:"li"},"param"))),(0,r.kt)("p",null,"When a route is matched, the value of its ",(0,r.kt)("em",{parentName:"p"},"params")," will be exposed as ",(0,r.kt)("inlineCode",{parentName:"p"},"params"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const User = {\n  template: '<div>User {{ $route.params.id }}</div>',\n}\n// these are passed to `createRouter`\nconst routes = [\n  // dynamic segments start with a colon\n  { path: '/users/:id', component: User },\n]\n")),(0,r.kt)("p",null,"You can have multiple ",(0,r.kt)("em",{parentName:"p"},"params")," in the same route, and they will map to corresponding fields on ",(0,r.kt)("inlineCode",{parentName:"p"},"params"),". Examples:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"pattern"),(0,r.kt)("th",{parentName:"tr",align:null},"matched path"),(0,r.kt)("th",{parentName:"tr",align:null},"params"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"/users/:username"),(0,r.kt)("td",{parentName:"tr",align:null},"/users/eduardo"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"{ username: 'eduardo' }"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"/users/:username/posts/:postId"),(0,r.kt)("td",{parentName:"tr",align:null},"/users/eduardo/posts/123"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"{ username: 'eduardo', postId: '123' }"))))),(0,r.kt)("h3",{id:"custom-regexp-in-params"},"Custom Regexp in params"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"const routes = [\n  // /:productName -> matches /o,/p\n  { path: '/:productName' },\n]\n")),(0,r.kt)("p",null,"In some scenarios we don't want to add that static section ",(0,r.kt)("inlineCode",{parentName:"p"},"/o"),"/",(0,r.kt)("inlineCode",{parentName:"p"},"p"),". However, ",(0,r.kt)("inlineCode",{parentName:"p"},"orderId")," is always a number while ",(0,r.kt)("inlineCode",{parentName:"p"},"productName")," can be anything, so we can specify a custom regexp for a param in parentheses:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const routes = [\n  // /:orderId -> matches only numbers\n  { path: '/:orderId(\\\\d+)' },\n  // /:productName -> matches anything else\n  { path: '/:productName' },\n]\n")),(0,r.kt)("p",null,"Now, going to ",(0,r.kt)("inlineCode",{parentName:"p"},"/25")," will match ",(0,r.kt)("inlineCode",{parentName:"p"},"/:orderId")," while going to anything else will match ",(0,r.kt)("inlineCode",{parentName:"p"},"/:productName"),". The order of the ",(0,r.kt)("inlineCode",{parentName:"p"},"routes")," array doesn't even matter!"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Make sure to ",(0,r.kt)("strong",{parentName:"p"},"escape backslashes (","\\",")")," like we did with ",(0,r.kt)("inlineCode",{parentName:"p"},"\\d")," (becomes ",(0,r.kt)("inlineCode",{parentName:"p"},"\\\\d"),") to actually pass the backslash character in a string in JavaScript.")),(0,r.kt)("h3",{id:"repeatable-params"},"Repeatable params"),(0,r.kt)("p",null,"If you need to match routes with multiple sections like ",(0,r.kt)("inlineCode",{parentName:"p"},"/first/second/third"),", you should mark a param as repeatable with ",(0,r.kt)("inlineCode",{parentName:"p"},"*")," (0 or more) and ",(0,r.kt)("inlineCode",{parentName:"p"},"+")," (1 or more):"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const routes = [\n  // /:chapters -> matches /one, /one/two, /one/two/three, etc\n  { path: '/:chapters+' },\n  // /:chapters -> matches /, /one, /one/two, /one/two/three, etc\n  { path: '/:chapters*' },\n]\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"// given { path: '/:chapters*', name: 'chapters' },\nrouter.resolve({ name: 'chapters', params: { chapters: [] } }).href\n// produces /\nrouter.resolve({ name: 'chapters', params: { chapters: ['a', 'b'] } }).href\n// produces /a/b\n\n// given { path: '/:chapters+', name: 'chapters' },\nrouter.resolve({ name: 'chapters', params: { chapters: [] } }).href\n// throws an Error because `chapters` is empty\n")),(0,r.kt)("p",null,"These can also be combined with custom Regexp by adding them ",(0,r.kt)("strong",{parentName:"p"},"after the closing parentheses"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const routes = [\n  // only match numbers\n  // matches /1, /1/2, etc\n  { path: '/:chapters(\\\\d+)+' },\n  // matches /, /1, /1/2, etc\n  { path: '/:chapters(\\\\d+)*' },\n]\n")),(0,r.kt)("h3",{id:"optional-parameters"},"Optional parameters"),(0,r.kt)("p",null,"You can also mark a parameter as optional by using the ",(0,r.kt)("inlineCode",{parentName:"p"},"?")," modifier (0 or 1):"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const routes = [\n  // will match /users and /users/posva\n  { path: '/users/:userId?' },\n  // will match /users and /users/42\n  { path: '/users/:userId(\\\\d+)?' },\n]\n")),(0,r.kt)("p",null,"Note that ",(0,r.kt)("inlineCode",{parentName:"p"},"*")," technically also marks a parameter as optional but ",(0,r.kt)("inlineCode",{parentName:"p"},"?")," parameters cannot be repeated."),(0,r.kt)("h3",{id:"catch-all--404-not-found-route"},"Catch all / 404 Not found Route"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"const routes = [\n  // will match /user/... and put it under `$route.params._other`\n  { path: '/user/:_other(.*)', name: 'NotFound', component: NotFound },\n  // will match /user, /user/... and put it under `$route.params._other`\n  { path: '/user/:_other(.*)?', name: 'NotFound', component: NotFound },\n  // will match anything starting with `/user-` and put it under `$route.params.afterUser`\n  { path: '/user-:afterUser(.*)', component: UserGeneric },\n]\n")),(0,r.kt)("h3",{id:"different-between-math-all"},"different between math all"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"pattern"),(0,r.kt)("th",{parentName:"tr",align:null},"matched path"),(0,r.kt)("th",{parentName:"tr",align:null},"\\$route.params"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"/:chapters*"),(0,r.kt)("td",{parentName:"tr",align:null},"/one"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"{ chapters: ['one'] }"))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"/:chapters(.*)"),(0,r.kt)("td",{parentName:"tr",align:null},"/one"),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"{ chapters: 'one' }"))))),(0,r.kt)("p",null,"This will give you an array of params instead of a string and will also require you to pass an array when using named routes:"),(0,r.kt)("h3",{id:"debugging"},"Debugging"),(0,r.kt)("p",null,"If you need to dig how your routes are transformed into Regexp to understand why a route isn't being matched or, to report a bug, you can use the ",(0,r.kt)("a",{parentName:"p",href:"https://paths.esm.dev/?p=AAMeJSyAwR4UbFDAFxAcAGAIJXMAAA..#"},"path ranker tool"),". It supports sharing your routes through the URL."),(0,r.kt)("h2",{id:"on-demand-transpilation"},"On demand transpilation"),(0,r.kt)("p",null,"Each route is a dynamic entry in shuvi. Some optimizations based on it."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"On demand transpilation when Developer visit a route"),(0,r.kt)("ol",{parentName:"li"},(0,r.kt)("li",{parentName:"ol"},"not yet visit /about",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"//empty route\nexport default function(){\n  return null\n}\n"))),(0,r.kt)("li",{parentName:"ol"},"when visit /about",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"//about route is compiling...\n"))),(0,r.kt)("li",{parentName:"ol"},"after compiled, about route will be replace to empty route by ",(0,r.kt)("a",{parentName:"li",href:"/shuvijs.org/docs/guide/Fast%20Refresh"},"fast fresh"),".",(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"//about route\nexport default function(){\n return <div>about</div>\n}\n"))))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Each route is lazy entry in production. it is on demand loaded when user visit a route."))))}d.isMDXComponent=!0}}]);